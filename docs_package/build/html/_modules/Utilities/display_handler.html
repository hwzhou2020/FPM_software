

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Utilities.display_handler &mdash; Fourier Ptychographic Microscopy Software 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Fourier Ptychographic Microscopy Software
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation_and_usage.html">Installation and Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Modules</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Fourier Ptychographic Microscopy Software</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">Utilities.display_handler</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for Utilities.display_handler</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PySide6.QtGui</span><span class="w"> </span><span class="kn">import</span> <span class="n">QImage</span><span class="p">,</span> <span class="n">QPixmap</span><span class="p">,</span> <span class="n">QColor</span><span class="p">,</span> <span class="n">QFont</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PySide6.QtWidgets</span><span class="w"> </span><span class="kn">import</span> <span class="n">QGraphicsScene</span><span class="p">,</span> <span class="n">QGraphicsSimpleTextItem</span><span class="p">,</span> <span class="n">QInputDialog</span><span class="p">,</span> <span class="n">QApplication</span><span class="p">,</span> <span class="n">QGraphicsView</span><span class="p">,</span> <span class="n">QGraphicsTextItem</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PySide6.QtCore</span><span class="w"> </span><span class="kn">import</span> <span class="n">Qt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Utilities.logging_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">log_message</span>


<div class="viewcode-block" id="mat2gray">
<a class="viewcode-back" href="../../display_handler.html#Utilities.display_handler.mat2gray">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mat2gray</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Normalize image to range [0, 255] for display.&quot;&quot;&quot;</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span>
    <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span></div>



<div class="viewcode-block" id="compute_spectrum">
<a class="viewcode-back" href="../../display_handler.html#Utilities.display_handler.compute_spectrum">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_spectrum</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the log-transformed spectrum of an image.&quot;&quot;&quot;</span>
    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spectrum</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mat2gray</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span></div>



<div class="viewcode-block" id="display_image">
<a class="viewcode-back" href="../../display_handler.html#Utilities.display_handler.display_image">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">display_image</span><span class="p">(</span><span class="n">ui</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">frame_number</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">total_frames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display an image in `display_window` with dynamic scaling and fixed-size frame number overlay.&quot;&quot;&quot;</span>
    <span class="n">scene</span> <span class="o">=</span> <span class="n">QGraphicsScene</span><span class="p">()</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Normalize and convert image to 8-bit grayscale</span>
    <span class="n">image</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span> <span class="o">-</span> <span class="n">image</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">image</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">*</span> <span class="mi">255</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>  <span class="c1"># Ensure C-contiguous memory</span>

    <span class="n">q_image</span> <span class="o">=</span> <span class="n">QImage</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">QImage</span><span class="o">.</span><span class="n">Format_Grayscale8</span><span class="p">)</span>
    <span class="n">pixmap</span> <span class="o">=</span> <span class="n">QPixmap</span><span class="o">.</span><span class="n">fromImage</span><span class="p">(</span><span class="n">q_image</span><span class="p">)</span>
    <span class="n">pixmap_item</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">addPixmap</span><span class="p">(</span><span class="n">pixmap</span><span class="p">)</span>

    <span class="c1"># Add frame number overlay with a fixed size</span>
    <span class="k">if</span> <span class="n">frame_number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">text_item</span> <span class="o">=</span> <span class="n">QGraphicsTextItem</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frame </span><span class="si">{</span><span class="n">frame_number</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_frames</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text_item</span><span class="o">.</span><span class="n">setDefaultTextColor</span><span class="p">(</span><span class="n">QColor</span><span class="p">(</span><span class="s2">&quot;#F38181&quot;</span><span class="p">))</span>  <span class="c1"># Soft coral color</span>
        <span class="n">text_font</span> <span class="o">=</span> <span class="n">QFont</span><span class="p">(</span><span class="s2">&quot;Arial&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">text_font</span><span class="o">.</span><span class="n">setBold</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">text_item</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">text_font</span><span class="p">)</span>

        <span class="c1"># Ensure text size remains fixed regardless of zoom level</span>
        <span class="n">text_item</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="n">QGraphicsTextItem</span><span class="o">.</span><span class="n">ItemIgnoresTransformations</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Add text to scene and position it in the top-left corner</span>
        <span class="n">scene</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text_item</span><span class="p">)</span>
        <span class="n">text_item</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="c1"># Update display window</span>
    <span class="n">ui</span><span class="o">.</span><span class="n">display_window</span><span class="o">.</span><span class="n">setScene</span><span class="p">(</span><span class="n">scene</span><span class="p">)</span>
    <span class="n">ui</span><span class="o">.</span><span class="n">display_window</span><span class="o">.</span><span class="n">setSceneRect</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">itemsBoundingRect</span><span class="p">())</span>
    <span class="n">ui</span><span class="o">.</span><span class="n">display_window</span><span class="o">.</span><span class="n">fitInView</span><span class="p">(</span><span class="n">pixmap_item</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">KeepAspectRatio</span><span class="p">)</span>

    <span class="c1"># Enable zooming and dragging</span>
    <span class="n">ui</span><span class="o">.</span><span class="n">display_window</span><span class="o">.</span><span class="n">setDragMode</span><span class="p">(</span><span class="n">QGraphicsView</span><span class="o">.</span><span class="n">ScrollHandDrag</span><span class="p">)</span>
    <span class="n">ui</span><span class="o">.</span><span class="n">display_window</span><span class="o">.</span><span class="n">setTransformationAnchor</span><span class="p">(</span><span class="n">QGraphicsView</span><span class="o">.</span><span class="n">AnchorUnderMouse</span><span class="p">)</span></div>



<div class="viewcode-block" id="display_single_raw_frame">
<a class="viewcode-back" href="../../display_handler.html#Utilities.display_handler.display_single_raw_frame">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">display_single_raw_frame</span><span class="p">(</span><span class="n">main_window</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prompt user for a frame number and display the selected raw image in `display_window`.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="s2">&quot;mat_data&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">main_window</span><span class="o">.</span><span class="n">mat_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">Msg_window</span><span class="o">.</span><span class="n">appendPlainText</span><span class="p">(</span><span class="s2">&quot;Error: No data loaded. Please load a .mat file first.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="s2">&quot;imlow&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">main_window</span><span class="o">.</span><span class="n">mat_data</span><span class="p">:</span>
        <span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">Msg_window</span><span class="o">.</span><span class="n">appendPlainText</span><span class="p">(</span><span class="s2">&quot;Error: &#39;imlow&#39; not found in .mat file.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">imlow</span> <span class="o">=</span> <span class="n">main_window</span><span class="o">.</span><span class="n">mat_data</span><span class="p">[</span><span class="s2">&quot;imlow&quot;</span><span class="p">]</span>
    <span class="n">num_frames</span> <span class="o">=</span> <span class="n">imlow</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Number of frames in `imlow`</span>

    <span class="c1"># Ask the user for the frame number</span>
    <span class="n">frame</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">QInputDialog</span><span class="o">.</span><span class="n">getInt</span><span class="p">(</span>
        <span class="n">main_window</span><span class="p">,</span> <span class="s2">&quot;Select Frame&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;Enter frame number (1 to </span><span class="si">{</span><span class="n">num_frames</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_frames</span><span class="p">,</span> <span class="mi">1</span>  <span class="c1"># Default value, min value, max value, step</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
        <span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">Msg_window</span><span class="o">.</span><span class="n">appendPlainText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Displaying frame </span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">num_frames</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">display_image</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="p">,</span> <span class="n">imlow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">frame</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">frame_number</span><span class="o">=</span><span class="n">frame</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">total_frames</span><span class="o">=</span><span class="n">num_frames</span><span class="p">)</span></div>



<div class="viewcode-block" id="display_all_raw_frames">
<a class="viewcode-back" href="../../display_handler.html#Utilities.display_handler.display_all_raw_frames">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">display_all_raw_frames</span><span class="p">(</span><span class="n">main_window</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display all raw images sequentially in `display_window` with a short delay.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="s2">&quot;mat_data&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">main_window</span><span class="o">.</span><span class="n">mat_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">Msg_window</span><span class="o">.</span><span class="n">appendPlainText</span><span class="p">(</span><span class="s2">&quot;Error: No data loaded. Please load a .mat file first.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="s2">&quot;imlow&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">main_window</span><span class="o">.</span><span class="n">mat_data</span><span class="p">:</span>
        <span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">Msg_window</span><span class="o">.</span><span class="n">appendPlainText</span><span class="p">(</span><span class="s2">&quot;Error: &#39;imlow&#39; not found in .mat file.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">imlow</span> <span class="o">=</span> <span class="n">main_window</span><span class="o">.</span><span class="n">mat_data</span><span class="p">[</span><span class="s2">&quot;imlow&quot;</span><span class="p">]</span>
    <span class="n">num_frames</span> <span class="o">=</span> <span class="n">imlow</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">Msg_window</span><span class="o">.</span><span class="n">appendPlainText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Displaying all </span><span class="si">{</span><span class="n">num_frames</span><span class="si">}</span><span class="s2"> frames sequentially.&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_frames</span><span class="p">):</span>
        <span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">Msg_window</span><span class="o">.</span><span class="n">appendPlainText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Displaying frame </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">num_frames</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">display_image</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="p">,</span> <span class="n">imlow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">frame_number</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">total_frames</span><span class="o">=</span><span class="n">num_frames</span><span class="p">)</span>

        <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>  <span class="c1"># Allow UI updates</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># Delay between frames</span></div>



<div class="viewcode-block" id="display_single_raw_spectrum">
<a class="viewcode-back" href="../../display_handler.html#Utilities.display_handler.display_single_raw_spectrum">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">display_single_raw_spectrum</span><span class="p">(</span><span class="n">main_window</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prompt user for a frame number and display the spectrum of the selected raw image in `display_window`.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="s2">&quot;mat_data&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">main_window</span><span class="o">.</span><span class="n">mat_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">Msg_window</span><span class="o">.</span><span class="n">appendPlainText</span><span class="p">(</span><span class="s2">&quot;Error: No data loaded. Please load a .mat file first.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="s2">&quot;imlow&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">main_window</span><span class="o">.</span><span class="n">mat_data</span><span class="p">:</span>
        <span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">Msg_window</span><span class="o">.</span><span class="n">appendPlainText</span><span class="p">(</span><span class="s2">&quot;Error: &#39;imlow&#39; not found in .mat file.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">imlow</span> <span class="o">=</span> <span class="n">main_window</span><span class="o">.</span><span class="n">mat_data</span><span class="p">[</span><span class="s2">&quot;imlow&quot;</span><span class="p">]</span>
    <span class="n">num_frames</span> <span class="o">=</span> <span class="n">imlow</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Number of frames in `imlow`</span>

    <span class="c1"># Ask the user for the frame number</span>
    <span class="n">frame</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">QInputDialog</span><span class="o">.</span><span class="n">getInt</span><span class="p">(</span>
        <span class="n">main_window</span><span class="p">,</span> <span class="s2">&quot;Select Frame&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;Enter frame number (1 to </span><span class="si">{</span><span class="n">num_frames</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_frames</span><span class="p">,</span> <span class="mi">1</span>  <span class="c1"># Default value, min value, max value, step</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
        <span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">Msg_window</span><span class="o">.</span><span class="n">appendPlainText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Displaying spectrum of frame </span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">num_frames</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">compute_spectrum</span><span class="p">(</span><span class="n">imlow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">frame</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">display_image</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">frame_number</span><span class="o">=</span><span class="n">frame</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">total_frames</span><span class="o">=</span><span class="n">num_frames</span><span class="p">)</span></div>



<div class="viewcode-block" id="display_all_raw_spectra">
<a class="viewcode-back" href="../../display_handler.html#Utilities.display_handler.display_all_raw_spectra">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">display_all_raw_spectra</span><span class="p">(</span><span class="n">main_window</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display all raw image spectra sequentially with a delay in `display_window`.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="s2">&quot;mat_data&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">main_window</span><span class="o">.</span><span class="n">mat_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">Msg_window</span><span class="o">.</span><span class="n">appendPlainText</span><span class="p">(</span><span class="s2">&quot;Error: No data loaded. Please load a .mat file first.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="s2">&quot;imlow&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">main_window</span><span class="o">.</span><span class="n">mat_data</span><span class="p">:</span>
        <span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">Msg_window</span><span class="o">.</span><span class="n">appendPlainText</span><span class="p">(</span><span class="s2">&quot;Error: &#39;imlow&#39; not found in .mat file.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">imlow</span> <span class="o">=</span> <span class="n">main_window</span><span class="o">.</span><span class="n">mat_data</span><span class="p">[</span><span class="s2">&quot;imlow&quot;</span><span class="p">]</span>
    <span class="n">num_frames</span> <span class="o">=</span> <span class="n">imlow</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">Msg_window</span><span class="o">.</span><span class="n">appendPlainText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Displaying spectra of all </span><span class="si">{</span><span class="n">num_frames</span><span class="si">}</span><span class="s2"> frames sequentially.&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_frames</span><span class="p">):</span>
        <span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">Msg_window</span><span class="o">.</span><span class="n">appendPlainText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Displaying spectrum of frame </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">num_frames</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">compute_spectrum</span><span class="p">(</span><span class="n">imlow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="n">display_image</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">frame_number</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">total_frames</span><span class="o">=</span><span class="n">num_frames</span><span class="p">)</span>

        <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>  <span class="c1"># Allow UI updates</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># Delay between frames</span></div>



<div class="viewcode-block" id="display_single_roi_image">
<a class="viewcode-back" href="../../display_handler.html#Utilities.display_handler.display_single_roi_image">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">display_single_roi_image</span><span class="p">(</span><span class="n">main_window</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Displays a single ROI frame from the selected region.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">main_window</span><span class="o">.</span><span class="n">mat_data</span> <span class="ow">or</span> <span class="s2">&quot;imlow&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">main_window</span><span class="o">.</span><span class="n">mat_data</span><span class="p">:</span>
        <span class="n">log_message</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="p">,</span> <span class="s2">&quot;Error: No data loaded.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">imlow</span> <span class="o">=</span> <span class="n">main_window</span><span class="o">.</span><span class="n">mat_data</span><span class="p">[</span><span class="s2">&quot;imlow&quot;</span><span class="p">]</span>
    <span class="n">num_frames</span> <span class="o">=</span> <span class="n">imlow</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Total frames</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="s2">&quot;roi_params&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">roi_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">log_message</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="p">,</span> <span class="s2">&quot;Error: No ROI selected.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">roi_x</span> <span class="o">=</span> <span class="n">main_window</span><span class="o">.</span><span class="n">roi_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x_offset&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">roi_y</span> <span class="o">=</span> <span class="n">main_window</span><span class="o">.</span><span class="n">roi_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_offset&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">roi_size</span> <span class="o">=</span> <span class="n">main_window</span><span class="o">.</span><span class="n">roi_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;roi_size&quot;</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>

    <span class="n">roi_image</span> <span class="o">=</span> <span class="n">imlow</span><span class="p">[</span><span class="n">roi_y</span><span class="p">:</span><span class="n">roi_y</span> <span class="o">+</span> <span class="n">roi_size</span><span class="p">,</span> <span class="n">roi_x</span><span class="p">:</span><span class="n">roi_x</span> <span class="o">+</span> <span class="n">roi_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># First frame</span>

    <span class="n">log_message</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Displaying ROI frame 1 of </span><span class="si">{</span><span class="n">num_frames</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">display_image</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="p">,</span> <span class="n">roi_image</span><span class="p">,</span> <span class="n">frame_number</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_frames</span><span class="o">=</span><span class="n">num_frames</span><span class="p">)</span></div>




<div class="viewcode-block" id="display_all_roi_images">
<a class="viewcode-back" href="../../display_handler.html#Utilities.display_handler.display_all_roi_images">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">display_all_roi_images</span><span class="p">(</span><span class="n">main_window</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Displays all ROI frames sequentially with a 0.1s delay.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">main_window</span><span class="o">.</span><span class="n">mat_data</span> <span class="ow">or</span> <span class="s2">&quot;imlow&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">main_window</span><span class="o">.</span><span class="n">mat_data</span><span class="p">:</span>
        <span class="n">log_message</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="p">,</span> <span class="s2">&quot;Error: No data loaded.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">imlow</span> <span class="o">=</span> <span class="n">main_window</span><span class="o">.</span><span class="n">mat_data</span><span class="p">[</span><span class="s2">&quot;imlow&quot;</span><span class="p">]</span>
    <span class="n">num_frames</span> <span class="o">=</span> <span class="n">imlow</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Total frames</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="s2">&quot;roi_params&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">roi_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">log_message</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="p">,</span> <span class="s2">&quot;Error: No ROI selected.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">roi_x</span> <span class="o">=</span> <span class="n">main_window</span><span class="o">.</span><span class="n">roi_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x_offset&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">roi_y</span> <span class="o">=</span> <span class="n">main_window</span><span class="o">.</span><span class="n">roi_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_offset&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">roi_size</span> <span class="o">=</span> <span class="n">main_window</span><span class="o">.</span><span class="n">roi_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;roi_size&quot;</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_frames</span><span class="p">):</span>
        <span class="n">roi_image</span> <span class="o">=</span> <span class="n">imlow</span><span class="p">[</span><span class="n">roi_y</span><span class="p">:</span><span class="n">roi_y</span> <span class="o">+</span> <span class="n">roi_size</span><span class="p">,</span> <span class="n">roi_x</span><span class="p">:</span><span class="n">roi_x</span> <span class="o">+</span> <span class="n">roi_size</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>

        <span class="n">log_message</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Displaying ROI frame </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">num_frames</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">display_image</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="p">,</span> <span class="n">roi_image</span><span class="p">,</span> <span class="n">frame_number</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">total_frames</span><span class="o">=</span><span class="n">num_frames</span><span class="p">)</span>

        <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span></div>




<div class="viewcode-block" id="display_result_image">
<a class="viewcode-back" href="../../display_handler.html#Utilities.display_handler.display_result_image">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">display_result_image</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s2">&quot;amplitude&quot;</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">main_window</span><span class="p">,</span> <span class="s2">&quot;reconstruction_result&quot;</span><span class="p">):</span>
        <span class="n">log_message</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="p">,</span> <span class="s2">&quot;Error: No reconstruction results available.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">main_window</span><span class="o">.</span><span class="n">reconstruction_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">result_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_message</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">result_type</span><span class="si">}</span><span class="s2"> result not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Convert pupil to phase for display</span>
    <span class="k">if</span> <span class="n">result_type</span> <span class="o">==</span> <span class="s2">&quot;pupil&quot;</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

    <span class="c1"># if it is all zeros, just display zeros to avoid division by zero</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">image</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">log_message</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="p">,</span> <span class="s2">&quot;Warning: Result image is all zeros. Displaying zero image.&quot;</span><span class="p">)</span>
        <span class="n">image_uint8</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Normalize and convert to 8-bit image</span>
        <span class="n">image</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">image</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span>
        <span class="n">image_uint8</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">image_uint8</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">image_uint8</span><span class="p">)</span>  <span class="c1"># Ensure memory layout</span>

    <span class="n">display_image</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">ui</span><span class="p">,</span> <span class="n">image_uint8</span><span class="p">,</span> <span class="n">frame_number</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">total_frames</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>

    <span class="c1"># h, w = image.shape</span>
    <span class="c1"># q_image = QImage(image_uint8.data, w, h, w, QImage.Format_Grayscale8)</span>
    <span class="c1"># pixmap = QPixmap.fromImage(q_image)</span>

    <span class="c1"># # Create scene and add image</span>
    <span class="c1"># scene = QGraphicsScene()</span>
    <span class="c1"># pixmap_item = scene.addPixmap(pixmap)</span>

    <span class="c1"># # Add title overlay</span>
    <span class="c1"># # title = result_type.capitalize() + &quot; result&quot;</span>
    <span class="c1"># # text_item = QGraphicsSimpleTextItem(title)</span>
    <span class="c1"># # text_item.setBrush(QColor(&quot;#4A90E2&quot;))</span>
    <span class="c1"># # text_item.setFont(QFont(&quot;Arial&quot;, 16))</span>
    <span class="c1"># # text_item.setPos(10, 10)</span>
    <span class="c1"># # scene.addItem(text_item)</span>

    <span class="c1"># # Display</span>
    <span class="c1"># main_window.ui.display_window.setScene(scene)</span>
    <span class="c1"># main_window.ui.display_window.setSceneRect(scene.itemsBoundingRect())</span>
    <span class="c1"># main_window.ui.display_window.fitInView(pixmap_item, Qt.KeepAspectRatio)</span>
    <span class="c1"># main_window.ui.display_window.setDragMode(QGraphicsView.ScrollHandDrag)</span>
    <span class="c1"># main_window.ui.display_window.setTransformationAnchor(main_window.ui.display_window.AnchorUnderMouse)</span>

    <span class="c1"># log_message(main_window.ui, f&quot;Displayed {title}.&quot;)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>